# ğŸ” Railway 12306 ç”¨æˆ·è®¤è¯åŠŸèƒ½è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

Railway 12306 ç³»ç»Ÿå®ç°äº†å®Œæ•´çš„ç”¨æˆ·è®¤è¯å’Œæƒé™æ§åˆ¶åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æƒé™ç®¡ç†ã€ä¼šè¯ç®¡ç†ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨è¿™äº›åŠŸèƒ½ä»¥åŠå¦‚ä½•ä¸å…¶ä»–ç³»ç»Ÿè¿›è¡Œé›†æˆã€‚

## ğŸš€ å¿«é€Ÿå¯åŠ¨æŒ‡å—

### ç¯å¢ƒè¦æ±‚

**åŸºç¡€è¿è¡Œç¯å¢ƒ**:
- Python 3.10+
- Node.js 14+ (å½“å‰ç³»ç»Ÿä½¿ç”¨ npm 10.9.3ï¼Œå…¼å®¹æ€§è‰¯å¥½)
- pip (PythonåŒ…ç®¡ç†å™¨)
- npm æˆ– yarn (Node.jsåŒ…ç®¡ç†å™¨)

**æ•°æ®åº“ç¯å¢ƒ**:
- SQLite 3.0+ (å¼€å‘ç¯å¢ƒé»˜è®¤)
- PostgreSQL 12+ (ç”Ÿäº§ç¯å¢ƒæ¨è)
- MySQL 8.0+ (å¤‡é€‰æ–¹æ¡ˆ)

### æŠ€æœ¯æ ˆ

**åç«¯æŠ€æœ¯æ ˆ**:
- FastAPI 0.115+ (Webæ¡†æ¶)
- SQLAlchemy 2.0+ (ORMæ•°æ®åº“æ˜ å°„)
- Pydantic 2.10+ (æ•°æ®éªŒè¯å’Œåºåˆ—åŒ–)
- Python-JOSE 3.3+ (JWTä»¤ç‰Œå¤„ç†)
- Passlib 1.7+ (å¯†ç åŠ å¯†ï¼Œä½¿ç”¨bcrypt)
- Uvicorn 0.32+ (ASGIæœåŠ¡å™¨)
- Alembic (æ•°æ®åº“è¿ç§»å·¥å…·)

**å‰ç«¯æŠ€æœ¯æ ˆ**:
- Vue.js 3.4+ (æ¸è¿›å¼å‰ç«¯æ¡†æ¶)
- Vue Router 4.2+ (å•é¡µåº”ç”¨è·¯ç”±)
- Pinia 2.1+ (çŠ¶æ€ç®¡ç†åº“)
- Ant Design Vue 4.1+ (ä¼ä¸šçº§UIç»„ä»¶åº“)
- Axios 1.6+ (HTTPè¯·æ±‚åº“)
- Vite 5.0+ (å‰ç«¯æ„å»ºå·¥å…·)
- Day.js 1.11+ (æ—¥æœŸå¤„ç†åº“)

### 1. åç«¯å¯åŠ¨

#### 1.1 å®‰è£…ä¾èµ–
```bash
# è¿›å…¥åç«¯ç›®å½•
cd backend

# å®‰è£…Pythonä¾èµ–
pip install -r requirements.txt
```

#### 1.2 ç¯å¢ƒé…ç½®
```bash
# å¤åˆ¶ç¯å¢ƒé…ç½®æ–‡ä»¶
cp .env.test .env

# ç¼–è¾‘ç¯å¢ƒå˜é‡ (å¯é€‰)
# ä¸»è¦é…ç½®é¡¹:
# - SECRET_KEY: JWTå¯†é’¥
# - DATABASE_URL: æ•°æ®åº“è¿æ¥
# - CORS_ORIGINS: å…è®¸çš„å‰ç«¯åŸŸå
```

#### 1.3 æ•°æ®åº“åˆå§‹åŒ–
```bash
# åˆå§‹åŒ–æ•°æ®åº“
python init_test_db.py

# åˆ›å»ºæµ‹è¯•ç”¨æˆ· (å¯é€‰)
python create_test_user.py
```

#### 1.4 å¯åŠ¨åç«¯æœåŠ¡
```bash
# æ–¹å¼1: ä½¿ç”¨uvicornç›´æ¥å¯åŠ¨
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# æ–¹å¼2: ä½¿ç”¨å¯åŠ¨è„šæœ¬ (Linux/Mac)
./run.sh

# æ–¹å¼3: ä½¿ç”¨Pythonæ¨¡å—å¯åŠ¨
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**å¯åŠ¨æˆåŠŸæ ‡å¿—**:
- æ§åˆ¶å°æ˜¾ç¤º: `Uvicorn running on http://0.0.0.0:8000`
- è®¿é—® http://localhost:8000/docs å¯ä»¥çœ‹åˆ°APIæ–‡æ¡£
- è®¿é—® http://localhost:8000/health è¿”å›å¥åº·æ£€æŸ¥ä¿¡æ¯

### 2. å‰ç«¯å¯åŠ¨

#### 2.1 å®‰è£…ä¾èµ–
```bash
# è¿›å…¥å‰ç«¯ç›®å½•
cd frontend

# å®‰è£…Node.jsä¾èµ–
npm install

# æˆ–ä½¿ç”¨yarn
yarn install
```

#### 2.2 å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```bash
# ä½¿ç”¨npmå¯åŠ¨
npm run dev

# æˆ–ä½¿ç”¨yarnå¯åŠ¨
yarn dev
```

**å¯åŠ¨æˆåŠŸæ ‡å¿—**:
- æ§åˆ¶å°æ˜¾ç¤º: `Local: http://localhost:5173/`
- æµè§ˆå™¨è‡ªåŠ¨æ‰“å¼€ http://localhost:5173
- é¡µé¢æ­£å¸¸æ˜¾ç¤ºRailway 12306é¦–é¡µ

### 3. éªŒè¯å¯åŠ¨çŠ¶æ€

#### 3.1 åç«¯æœåŠ¡éªŒè¯
```bash
# æ£€æŸ¥APIå¥åº·çŠ¶æ€
curl http://localhost:8000/health

# æ£€æŸ¥APIæ–‡æ¡£
# æµè§ˆå™¨è®¿é—®: http://localhost:8000/docs
```

#### 3.2 å‰ç«¯æœåŠ¡éªŒè¯
```bash
# æ£€æŸ¥å‰ç«¯é¡µé¢
# æµè§ˆå™¨è®¿é—®: http://localhost:5173

# æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
# æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·æŸ¥çœ‹Console
```

#### 3.3 å‰åç«¯è¿é€šæ€§éªŒè¯
1. æ‰“å¼€å‰ç«¯é¡µé¢ http://localhost:5173
2. ç‚¹å‡»"ç™»å½•"æŒ‰é’®
3. å°è¯•ä½¿ç”¨æµ‹è¯•è´¦æˆ·ç™»å½•:
   - ç”¨æˆ·å: `testuser`
   - å¯†ç : `testpass123`
4. ç™»å½•æˆåŠŸè¡¨ç¤ºå‰åç«¯è¿æ¥æ­£å¸¸

### 4. å¸¸è§å¯åŠ¨é—®é¢˜

#### 4.1 åç«¯å¯åŠ¨é—®é¢˜

**é—®é¢˜**: `ModuleNotFoundError: No module named 'xxx'`
```bash
# è§£å†³æ–¹æ¡ˆ: é‡æ–°å®‰è£…ä¾èµ–
pip install -r requirements.txt

# æˆ–å‡çº§pipåé‡æ–°å®‰è£…
python -m pip install --upgrade pip
pip install -r requirements.txt
```

**é—®é¢˜**: `Port 8000 is already in use`
```bash
# è§£å†³æ–¹æ¡ˆ1: æ›´æ¢ç«¯å£
uvicorn app.main:app --reload --port 8001

# è§£å†³æ–¹æ¡ˆ2: æ€æ­»å ç”¨è¿›ç¨‹ (Windows)
netstat -ano | findstr :8000
taskkill /PID <PID> /F

# è§£å†³æ–¹æ¡ˆ2: æ€æ­»å ç”¨è¿›ç¨‹ (Linux/Mac)
lsof -ti:8000 | xargs kill -9
```

**é—®é¢˜**: æ•°æ®åº“è¿æ¥é”™è¯¯
```bash
# è§£å†³æ–¹æ¡ˆ: é‡æ–°åˆå§‹åŒ–æ•°æ®åº“
rm test_railway.db  # åˆ é™¤æ—§æ•°æ®åº“
python init_test_db.py  # é‡æ–°åˆå§‹åŒ–
```

#### 4.2 å‰ç«¯å¯åŠ¨é—®é¢˜

**é—®é¢˜**: `npm ERR! code ENOENT`
```bash
# è§£å†³æ–¹æ¡ˆ: æ¸…ç†ç¼“å­˜é‡æ–°å®‰è£…
rm -rf node_modules package-lock.json
npm cache clean --force
npm install
```

**é—®é¢˜**: `Port 5173 is already in use`
```bash
# è§£å†³æ–¹æ¡ˆ1: Viteä¼šè‡ªåŠ¨é€‰æ‹©å…¶ä»–ç«¯å£
# æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºçš„å®é™…ç«¯å£å·

# è§£å†³æ–¹æ¡ˆ2: æ‰‹åŠ¨æŒ‡å®šç«¯å£
npm run dev -- --port 3000
```

**é—®é¢˜**: å‰ç«¯æ— æ³•è¿æ¥åç«¯API
```bash
# æ£€æŸ¥åç«¯æ˜¯å¦æ­£å¸¸è¿è¡Œ
curl http://localhost:8000/health

# æ£€æŸ¥CORSé…ç½®
# ç¡®ä¿backend/.envä¸­CORS_ORIGINSåŒ…å«å‰ç«¯åœ°å€
CORS_ORIGINS=["http://localhost:5173","http://localhost:3000"]
```

### 5. å¼€å‘æ¨¡å¼ vs ç”Ÿäº§æ¨¡å¼

#### 5.1 å¼€å‘æ¨¡å¼ (å½“å‰é…ç½®)
- **åç«¯**: çƒ­é‡è½½ï¼Œè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ŒSQLiteæ•°æ®åº“
- **å‰ç«¯**: çƒ­é‡è½½ï¼ŒSource Mapï¼Œå¼€å‘è€…å·¥å…·æ”¯æŒ
- **é€‚ç”¨**: æœ¬åœ°å¼€å‘ã€åŠŸèƒ½æµ‹è¯•

#### 5.2 ç”Ÿäº§æ¨¡å¼éƒ¨ç½²
```bash
# å‰ç«¯æ„å»º
cd frontend
npm run build

# åç«¯ç”Ÿäº§å¯åŠ¨
cd backend
uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
```

### 6. å¼€å‘å·¥å…·æ¨è

#### 6.1 åç«¯å¼€å‘
- **IDE**: PyCharm, VS Code
- **APIæµ‹è¯•**: Postman, Insomnia
- **æ•°æ®åº“ç®¡ç†**: DB Browser for SQLite

#### 6.2 å‰ç«¯å¼€å‘
- **IDE**: VS Code, WebStorm
- **æµè§ˆå™¨**: Chrome DevTools
- **Vueå¼€å‘**: Vue DevTools æµè§ˆå™¨æ‰©å±•

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### è®¤è¯æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯åº”ç”¨      â”‚    â”‚   åç«¯API       â”‚    â”‚   æ•°æ®åº“        â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ç™»å½•é¡µé¢    â”‚ â”‚â—„â”€â”€â–ºâ”‚ â”‚ è®¤è¯API     â”‚ â”‚â—„â”€â”€â–ºâ”‚ â”‚ ç”¨æˆ·è¡¨      â”‚ â”‚
â”‚ â”‚ æ³¨å†Œé¡µé¢    â”‚ â”‚    â”‚ â”‚ JWTéªŒè¯     â”‚ â”‚    â”‚ â”‚ è§’è‰²è¡¨      â”‚ â”‚
â”‚ â”‚ æƒé™æ§åˆ¶    â”‚ â”‚    â”‚ â”‚ æƒé™æ§åˆ¶    â”‚ â”‚    â”‚ â”‚ æƒé™è¡¨      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½

### 1. ç”¨æˆ·è®¤è¯ç³»ç»Ÿ

#### 1.1 ç”¨æˆ·æ³¨å†Œ
- **åŠŸèƒ½æè¿°**: æ–°ç”¨æˆ·è´¦æˆ·åˆ›å»º
- **å®ç°ä½ç½®**: 
  - å‰ç«¯: `frontend/src/views/auth/RegisterPage.vue`
  - åç«¯: `backend/app/api/v1/endpoints/auth.py`
- **ä¸»è¦ç‰¹æ€§**:
  - âœ… ç”¨æˆ·åã€å¯†ç ã€å®åä¿¡æ¯éªŒè¯
  - âœ… èº«ä»½è¯å·ç æ ¼å¼éªŒè¯
  - âœ… é‚®ç®±å’Œæ‰‹æœºå·éªŒè¯
  - âœ… å¯†ç å¼ºåº¦æ£€æŸ¥
  - âœ… ç”¨æˆ·åè®®ç¡®è®¤

#### 1.2 ç”¨æˆ·ç™»å½•
- **åŠŸèƒ½æè¿°**: ç”¨æˆ·èº«ä»½éªŒè¯å’Œä¼šè¯å»ºç«‹
- **å®ç°ä½ç½®**:
  - å‰ç«¯: `frontend/src/views/auth/LoginPage.vue`
  - åç«¯: `backend/app/api/v1/endpoints/auth.py`
- **æ”¯æŒæ–¹å¼**:
  - ğŸ“± ç”¨æˆ·å/é‚®ç®±/æ‰‹æœºå·ç™»å½•
  - ğŸ” å¯†ç ç™»å½•
  - ğŸ“± çŸ­ä¿¡éªŒè¯ç ç™»å½•
  - ğŸ“± äºŒç»´ç æ‰«ç ç™»å½•
  - ğŸ”’ è®°ä½ç™»å½•çŠ¶æ€

#### 1.3 å¯†ç é‡ç½®
- **åŠŸèƒ½æè¿°**: å¿˜è®°å¯†ç æ—¶çš„å¯†ç é‡ç½®åŠŸèƒ½
- **å®ç°ä½ç½®**: `frontend/src/views/auth/ForgotPasswordPage.vue`
- **æ”¯æŒæ–¹å¼**:
  - ğŸ‘¤ äººè„¸è¯†åˆ«éªŒè¯
  - ğŸ“± æ‰‹æœºçŸ­ä¿¡éªŒè¯
  - ğŸ“§ é‚®ç®±éªŒè¯

### 2. æƒé™æ§åˆ¶ç³»ç»Ÿ (RBAC)

#### 2.1 è§’è‰²å®šä¹‰
```
ç³»ç»Ÿè§’è‰²å±‚æ¬¡:
â”œâ”€â”€ Super Admin (è¶…çº§ç®¡ç†å‘˜)
â”‚   â”œâ”€â”€ ç³»ç»Ÿç®¡ç†æƒé™
â”‚   â”œâ”€â”€ ç”¨æˆ·ç®¡ç†æƒé™
â”‚   â””â”€â”€ æ‰€æœ‰ä¸šåŠ¡æƒé™
â”œâ”€â”€ Admin (ç®¡ç†å‘˜)
â”‚   â”œâ”€â”€ ç”¨æˆ·ç®¡ç†æƒé™
â”‚   â”œâ”€â”€ è®¢å•ç®¡ç†æƒé™
â”‚   â””â”€â”€ è½¦æ¬¡ç®¡ç†æƒé™
â”œâ”€â”€ Manager (ç»ç†)
â”‚   â”œâ”€â”€ è®¢å•æŸ¥çœ‹æƒé™
â”‚   â””â”€â”€ æŠ¥è¡¨æŸ¥çœ‹æƒé™
â”œâ”€â”€ User (æ™®é€šç”¨æˆ·)
â”‚   â”œâ”€â”€ è´­ç¥¨æƒé™
â”‚   â””â”€â”€ ä¸ªäººä¿¡æ¯ç®¡ç†æƒé™
â””â”€â”€ Guest (è®¿å®¢)
    â””â”€â”€ åŸºæœ¬æŸ¥çœ‹æƒé™
```

#### 2.2 æƒé™æ§åˆ¶å®ç°
- **åç«¯æƒé™éªŒè¯**: 
  - è£…é¥°å™¨: `@require_admin`, `@require_permissions`
  - ä¾èµ–æ³¨å…¥: `get_current_user`, `require_admin`
- **å‰ç«¯æƒé™æ§åˆ¶**:
  - æŒ‡ä»¤: `v-permission`, `v-role`, `v-auth`
  - ç»„ä»¶: `PermissionWrapper`, `PermissionButton`
  - è·¯ç”±å®ˆå«: `permissionGuard`, `adminGuard`

### 3. ä¼šè¯ç®¡ç†

#### 3.1 JWTä»¤ç‰Œç®¡ç†
- **ä»¤ç‰Œç±»å‹**: Bearer Token
- **åŠ å¯†ç®—æ³•**: HS256
- **è¿‡æœŸæ—¶é—´**: 7å¤© (å¯é…ç½®)
- **å­˜å‚¨ä½ç½®**: 
  - å‰ç«¯: Cookie + LocalStorage
  - åç«¯: æ— çŠ¶æ€éªŒè¯

#### 3.2 ä¼šè¯ç‰¹æ€§
- âœ… è‡ªåŠ¨ä»¤ç‰Œåˆ·æ–°
- âœ… å¤šè®¾å¤‡ç™»å½•æ”¯æŒ
- âœ… ä¼šè¯è¶…æ—¶å¤„ç†
- âœ… å®‰å…¨ç™»å‡º

## ğŸš€ ä½¿ç”¨æŒ‡å—

### 1. å‰ç«¯ä½¿ç”¨

#### 1.1 ç”¨æˆ·çŠ¶æ€ç®¡ç†
```javascript
// ä½¿ç”¨ç”¨æˆ·çŠ¶æ€
import { useUserStore } from '@/stores/user'

const userStore = useUserStore()

// æ£€æŸ¥ç™»å½•çŠ¶æ€
if (userStore.isAuthenticated) {
  // ç”¨æˆ·å·²ç™»å½•
}

// è·å–ç”¨æˆ·ä¿¡æ¯
const user = userStore.user
const token = userStore.token
```

#### 1.2 æƒé™æ§åˆ¶ä½¿ç”¨
```vue
<!-- ä½¿ç”¨æƒé™æŒ‡ä»¤ -->
<template>
  <!-- åŸºäºæƒé™æ˜¾ç¤º -->
  <button v-permission="'user:create'">åˆ›å»ºç”¨æˆ·</button>
  
  <!-- åŸºäºè§’è‰²æ˜¾ç¤º -->
  <div v-role="'admin'">ç®¡ç†å‘˜ä¸“ç”¨å†…å®¹</div>
  
  <!-- åŸºäºè®¤è¯çŠ¶æ€æ˜¾ç¤º -->
  <span v-auth>å·²ç™»å½•ç”¨æˆ·å¯è§</span>
  
  <!-- ä½¿ç”¨æƒé™ç»„ä»¶ -->
  <PermissionWrapper :permissions="['user:edit']">
    <button>ç¼–è¾‘ç”¨æˆ·</button>
  </PermissionWrapper>
  
  <!-- ä½¿ç”¨æƒé™æŒ‰é’® -->
  <PermissionButton 
    :permissions="['user:delete']"
    type="danger"
    @click="deleteUser"
  >
    åˆ é™¤ç”¨æˆ·
  </PermissionButton>
</template>
```

#### 1.3 APIè°ƒç”¨ç¤ºä¾‹
```javascript
// ç”¨æˆ·ç™»å½•
const loginResult = await userStore.login({
  username: 'testuser',
  password: 'password123'
})

// ç”¨æˆ·æ³¨å†Œ
const registerResult = await userStore.register({
  username: 'newuser',
  password: 'password123',
  email: 'user@example.com',
  realName: 'å¼ ä¸‰',
  idNumber: '123456789012345678'
})

// è·å–ç”¨æˆ·ä¿¡æ¯
const profile = await userStore.fetchUserProfile()
```

### 2. åç«¯APIä½¿ç”¨

#### 2.1 è®¤è¯APIç«¯ç‚¹
```bash
# ç”¨æˆ·æ³¨å†Œ
POST /api/auth/register
Content-Type: application/json
{
  "username": "testuser",
  "password": "password123",
  "email": "user@example.com",
  "real_name": "å¼ ä¸‰",
  "id_number": "123456789012345678"
}

# ç”¨æˆ·ç™»å½•
POST /api/auth/login
Content-Type: application/json
{
  "username": "testuser",
  "password": "password123"
}

# ä»¤ç‰ŒéªŒè¯
GET /api/auth/test-token
Authorization: Bearer <jwt_token>

# ç”¨æˆ·ç™»å‡º
POST /api/auth/logout
Authorization: Bearer <jwt_token>
```

#### 2.2 æƒé™ä¿æŠ¤çš„API
```python
from fastapi import APIRouter, Depends
from app.api.deps import get_current_user, require_admin

router = APIRouter()

# éœ€è¦ç™»å½•çš„æ¥å£
@router.get("/profile")
async def get_profile(current_user: User = Depends(get_current_user)):
    return current_user

# éœ€è¦ç®¡ç†å‘˜æƒé™çš„æ¥å£
@router.get("/admin/users")
async def get_all_users(current_user: User = Depends(require_admin)):
    # åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®
    pass
```

## ğŸ”Œ æ¥å£é›†æˆæŒ‡å—

### 1. ä½œä¸ºè®¤è¯æä¾›æ–¹ (å…¶ä»–ç³»ç»Ÿæ¥å…¥)

#### 1.1 JWTä»¤ç‰ŒéªŒè¯
å…¶ä»–ç³»ç»Ÿå¯ä»¥é€šè¿‡éªŒè¯JWTä»¤ç‰Œæ¥ç¡®è®¤ç”¨æˆ·èº«ä»½ï¼š

```python
# å…¶ä»–ç³»ç»ŸéªŒè¯Railway 12306çš„JWTä»¤ç‰Œ
import jwt
from datetime import datetime

def verify_railway_token(token: str, secret_key: str):
    try:
        payload = jwt.decode(token, secret_key, algorithms=["HS256"])
        
        # æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ
        exp = payload.get("exp")
        if exp and datetime.fromtimestamp(exp) < datetime.now():
            return None, "ä»¤ç‰Œå·²è¿‡æœŸ"
        
        # è·å–ç”¨æˆ·ä¿¡æ¯
        user_id = payload.get("sub")
        username = payload.get("username")
        
        return {
            "user_id": user_id,
            "username": username,
            "valid": True
        }, None
        
    except jwt.InvalidTokenError:
        return None, "æ— æ•ˆä»¤ç‰Œ"
```

#### 1.2 ç”¨æˆ·ä¿¡æ¯API
```bash
# è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
GET /api/users/profile
Authorization: Bearer <jwt_token>

# å“åº”æ ¼å¼
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "username": "testuser",
    "email": "user@example.com",
    "real_name": "å¼ ä¸‰",
    "roles": ["user"],
    "permissions": ["user:profile:read"]
  }
}
```

### 2. æ¥å…¥å…¶ä»–è®¤è¯ç³»ç»Ÿ

#### 2.1 OAuth 2.0 é›†æˆå‡†å¤‡
ç³»ç»Ÿé¢„ç•™äº†OAuthé›†æˆæ¥å£ï¼Œå¯ä»¥æ¥å…¥ç¬¬ä¸‰æ–¹è®¤è¯ï¼š

```python
# ç¬¬ä¸‰æ–¹ç™»å½•æ¥å£ç¤ºä¾‹
@router.post("/auth/oauth/login")
async def oauth_login(
    provider: str,  # å¦‚: "wechat", "alipay"
    code: str,      # æˆæƒç 
    db: Session = Depends(get_db)
):
    # 1. éªŒè¯æˆæƒç 
    user_info = await verify_oauth_code(provider, code)
    
    # 2. æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    user = get_or_create_oauth_user(db, user_info)
    
    # 3. ç”ŸæˆJWTä»¤ç‰Œ
    token = create_access_token(data={"sub": str(user.id)})
    
    return {"access_token": token, "token_type": "bearer"}
```

#### 2.2 LDAP/AD é›†æˆ
```python
# LDAPè®¤è¯é›†æˆç¤ºä¾‹
async def ldap_authenticate(username: str, password: str):
    import ldap3
    
    server = ldap3.Server('ldap://your-ldap-server')
    conn = ldap3.Connection(
        server, 
        user=f'cn={username},ou=users,dc=company,dc=com',
        password=password
    )
    
    if conn.bind():
        # LDAPè®¤è¯æˆåŠŸï¼Œè·å–ç”¨æˆ·ä¿¡æ¯
        user_info = get_ldap_user_info(conn, username)
        
        # åœ¨æœ¬åœ°æ•°æ®åº“ä¸­åŒæ­¥ç”¨æˆ·ä¿¡æ¯
        user = sync_ldap_user(user_info)
        
        return user
    
    return None
```

### 3. å•ç‚¹ç™»å½• (SSO) é›†æˆ

#### 3.1 ä½œä¸ºSSOæä¾›æ–¹
```python
# SSOç™»å½•ç«¯ç‚¹
@router.get("/sso/login")
async def sso_login(
    service: str,  # ç›®æ ‡æœåŠ¡URL
    current_user: User = Depends(get_current_user)
):
    # ç”ŸæˆSSOç¥¨æ®
    ticket = generate_sso_ticket(current_user.id, service)
    
    # é‡å®šå‘åˆ°ç›®æ ‡æœåŠ¡
    return RedirectResponse(
        url=f"{service}?ticket={ticket}",
        status_code=302
    )

# SSOç¥¨æ®éªŒè¯
@router.post("/sso/validate")
async def validate_sso_ticket(ticket: str, service: str):
    user_info = verify_sso_ticket(ticket, service)
    if user_info:
        return {"valid": True, "user": user_info}
    else:
        return {"valid": False, "error": "Invalid ticket"}
```

#### 3.2 æ¥å…¥å…¶ä»–SSOç³»ç»Ÿ
```python
# æ¥å…¥CAS SSOç¤ºä¾‹
@router.get("/auth/cas/login")
async def cas_login():
    cas_server = "https://cas.example.com"
    service_url = "http://localhost:8000/auth/cas/callback"
    
    return RedirectResponse(
        url=f"{cas_server}/login?service={service_url}"
    )

@router.get("/auth/cas/callback")
async def cas_callback(ticket: str, db: Session = Depends(get_db)):
    # éªŒè¯CASç¥¨æ®
    user_info = validate_cas_ticket(ticket)
    
    if user_info:
        # åˆ›å»ºæœ¬åœ°ä¼šè¯
        user = get_or_create_user(db, user_info)
        token = create_access_token(data={"sub": str(user.id)})
        
        return {"access_token": token, "token_type": "bearer"}
    
    raise HTTPException(status_code=401, detail="CAS authentication failed")
```

## ğŸ”’ å®‰å…¨é…ç½®

### 1. ç¯å¢ƒå˜é‡é…ç½®
```env
# JWTé…ç½®
SECRET_KEY=your-super-secret-key-change-this-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=10080

# CORSé…ç½®
CORS_ORIGINS=["http://localhost:5173","http://localhost:3000"]

# æ•°æ®åº“é…ç½®
DATABASE_URL=sqlite:///./test_railway.db
```

### 2. å®‰å…¨æœ€ä½³å®è·µ

#### 2.1 å¯†ç å®‰å…¨
- âœ… ä½¿ç”¨bcryptåŠ å¯†å­˜å‚¨
- âœ… å¼ºåˆ¶å¯†ç å¤æ‚åº¦è¦æ±‚
- âœ… é˜²æ­¢å¯†ç é‡ç”¨
- âœ… å®šæœŸå¯†ç è¿‡æœŸæé†’

#### 2.2 ä¼šè¯å®‰å…¨
- âœ… JWTä»¤ç‰Œç­¾åéªŒè¯
- âœ… ä»¤ç‰Œè¿‡æœŸæ—¶é—´æ§åˆ¶
- âœ… å®‰å…¨çš„ä»¤ç‰Œå­˜å‚¨
- âœ… ç™»å‡ºæ—¶ä»¤ç‰Œå¤±æ•ˆ

#### 2.3 APIå®‰å…¨
- âœ… CORSè·¨åŸŸæ§åˆ¶
- âœ… è¯·æ±‚é€Ÿç‡é™åˆ¶
- âœ… è¾“å…¥æ•°æ®éªŒè¯
- âœ… SQLæ³¨å…¥é˜²æŠ¤

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. åŠŸèƒ½æµ‹è¯•
```bash
# è¿è¡Œè®¤è¯åŠŸèƒ½æµ‹è¯•
cd backend
python test_auth.py

# è¿è¡Œæƒé™æ§åˆ¶æµ‹è¯•
python test_permissions.py

# è¿è¡Œå®‰å…¨æœºåˆ¶æµ‹è¯•
python test_security.py
```

### 2. å‰ç«¯æµ‹è¯•
```bash
# è¿è¡Œå‰ç«¯æµ‹è¯•
cd frontend
npm run test

# è¿è¡ŒE2Eæµ‹è¯•
npm run test:e2e
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. è®¤è¯äº‹ä»¶æ—¥å¿—
ç³»ç»Ÿè®°å½•ä»¥ä¸‹è®¤è¯ç›¸å…³äº‹ä»¶ï¼š
- ç”¨æˆ·ç™»å½•æˆåŠŸ/å¤±è´¥
- å¯†ç é‡ç½®è¯·æ±‚
- æƒé™éªŒè¯å¤±è´¥
- ä»¤ç‰Œè¿‡æœŸäº‹ä»¶
- å¼‚å¸¸ç™»å½•è¡Œä¸º

### 2. æ€§èƒ½ç›‘æ§
- è®¤è¯æ¥å£å“åº”æ—¶é—´
- ä»¤ç‰ŒéªŒè¯æ€§èƒ½
- æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- ç¼“å­˜å‘½ä¸­ç‡

## ğŸ”§ æ•…éšœæ’é™¤

### 1. å¸¸è§é—®é¢˜

#### 1.1 ç™»å½•å¤±è´¥
```
é—®é¢˜: ç”¨æˆ·æ— æ³•ç™»å½•
æ’æŸ¥æ­¥éª¤:
1. æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ç”¨æˆ·è´¦æˆ·æ˜¯å¦è¢«ç¦ç”¨
3. æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
4. æŸ¥çœ‹åç«¯æ—¥å¿—é”™è¯¯ä¿¡æ¯
```

#### 1.2 æƒé™éªŒè¯å¤±è´¥
```
é—®é¢˜: ç”¨æˆ·æ— æ³•è®¿é—®æŸäº›åŠŸèƒ½
æ’æŸ¥æ­¥éª¤:
1. ç¡®è®¤ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
2. æ£€æŸ¥ç”¨æˆ·è§’è‰²å’Œæƒé™é…ç½®
3. éªŒè¯JWTä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ
4. æ£€æŸ¥å‰ç«¯æƒé™æŒ‡ä»¤é…ç½®
```

#### 1.3 ä»¤ç‰Œè¿‡æœŸ
```
é—®é¢˜: ä»¤ç‰Œé¢‘ç¹è¿‡æœŸ
è§£å†³æ–¹æ¡ˆ:
1. è°ƒæ•´ACCESS_TOKEN_EXPIRE_MINUTESé…ç½®
2. å®ç°è‡ªåŠ¨ä»¤ç‰Œåˆ·æ–°æœºåˆ¶
3. ä¼˜åŒ–å‰ç«¯ä»¤ç‰Œå­˜å‚¨ç­–ç•¥
```

### 2. è°ƒè¯•å·¥å…·
```bash
# JWTä»¤ç‰Œè°ƒè¯•
python debug_jwt.py

# æƒé™ç³»ç»Ÿè°ƒè¯•
python debug_permissions.py

# CORSé…ç½®æµ‹è¯•
python test_cors.py
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚éœ€æŠ€æœ¯æ”¯æŒæˆ–å‘ç°é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- ğŸ“§ é‚®ç®±: tech-support@railway12306.com
- ğŸ› é—®é¢˜è¿½è¸ª: GitHub Issues
- ğŸ“– æ–‡æ¡£: é¡¹ç›®Wiki
- ğŸ’¬ è®¨è®º: å¼€å‘è€…ç¤¾åŒº

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2024å¹´10æœˆ29æ—¥  
**ç»´æŠ¤å›¢é˜Ÿ**: Railway 12306 å¼€å‘å›¢é˜Ÿ