<template>
  <div class="forgot-password-page">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="header">
      <div class="header-content">
        <div class="logo">
          <div class="logo-icon">ğŸš„</div>
          <span class="logo-text">ä¸­å›½é“è·¯12306</span>
          <span class="subtitle">12306 CHINA RAILWAY</span>
        </div>
        <div class="header-nav">
          <a-button type="link" @click="$router.push('/login')">ç™»å½•</a-button>
          <a-button type="link" @click="$router.push('/register')">æ³¨å†Œ</a-button>
        </div>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
      <div class="forgot-container">
        <!-- é€‰é¡¹å¡å¯¼èˆª -->
        <div class="tab-navigation">
          <div
            class="tab-item"
            :class="{ active: activeTab === 'face' }"
            @click="activeTab = 'face'"
          >
            <i class="icon-face"></i>
            äººè„¸æ‰¾å›
          </div>
          <div
            class="tab-item"
            :class="{ active: activeTab === 'phone' }"
            @click="activeTab = 'phone'"
          >
            <i class="icon-phone"></i>
            æ‰‹æœºæ‰¾å›
          </div>
          <div
            class="tab-item"
            :class="{ active: activeTab === 'email' }"
            @click="activeTab = 'email'"
          >
            <i class="icon-email"></i>
            é‚®ç®±æ‰¾å›
          </div>
        </div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="tab-content">
          <!-- äººè„¸æ‰¾å› -->
          <div v-if="activeTab === 'face'" class="face-recovery">
            <div class="step-indicator">
              <div class="step" :class="{ active: faceStep >= 1, completed: faceStep > 1 }">
                <div class="step-number">1</div>
                <div class="step-text">æäº¤èº«ä»½ä¿¡æ¯</div>
              </div>
              <div class="step-line"></div>
              <div class="step" :class="{ active: faceStep >= 2, completed: faceStep > 2 }">
                <div class="step-number">2</div>
                <div class="step-text">éªŒè¯éªŒè¯ç </div>
              </div>
              <div class="step-line"></div>
              <div class="step" :class="{ active: faceStep >= 3, completed: faceStep > 3 }">
                <div class="step-number">3</div>
                <div class="step-text">è®¾ç½®æ–°å¯†ç </div>
              </div>
              <div class="step-line"></div>
              <div class="step" :class="{ active: faceStep >= 4 }">
                <div class="step-number">4</div>
                <div class="step-text">å®Œæˆ</div>
              </div>
            </div>

            <div class="qr-content" v-if="faceStep === 1">
              <h3 class="recovery-title">äººè„¸æ‰¾å›</h3>
              <p class="recovery-subtitle">
                æ‰«æäºŒç»´ç ï¼Œä½¿ç”¨
                <span class="app-name">12306APP</span>
                æ‰¾å›å¯†ç 
              </p>

              <div class="qr-code-container">
                <div class="qr-code">
                  <svg
                    width="160"
                    height="160"
                    viewBox="0 0 200 200"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <rect x="10" y="10" width="180" height="180" fill="white" stroke="#000" stroke-width="2" />
                    <rect x="20" y="20" width="50" height="50" fill="black" />
                    <rect x="30" y="30" width="30" height="30" fill="white" />
                    <rect x="40" y="40" width="10" height="10" fill="black" />
                    <rect x="130" y="20" width="50" height="50" fill="black" />
                    <rect x="140" y="30" width="30" height="30" fill="white" />
                    <rect x="150" y="40" width="10" height="10" fill="black" />
                    <rect x="20" y="130" width="50" height="50" fill="black" />
                    <rect x="30" y="140" width="30" height="30" fill="white" />
                    <rect x="40" y="150" width="10" height="10" fill="black" />
                    <circle cx="100" cy="100" r="15" fill="#e60012" />
                    <text x="100" y="105" text-anchor="middle" fill="white" font-size="12" font-weight="bold">ğŸš„</text>
                    <rect x="80" y="20" width="5" height="5" fill="black" />
                    <rect x="90" y="20" width="5" height="5" fill="black" />
                    <rect x="100" y="20" width="5" height="5" fill="black" />
                    <rect x="110" y="20" width="5" height="5" fill="black" />
                    <rect x="20" y="80" width="5" height="5" fill="black" />
                    <rect x="30" y="80" width="5" height="5" fill="black" />
                    <rect x="40" y="80" width="5" height="5" fill="black" />
                    <rect x="50" y="80" width="5" height="5" fill="black" />
                    <rect x="80" y="80" width="5" height="5" fill="black" />
                    <rect x="120" y="80" width="5" height="5" fill="black" />
                    <rect x="130" y="80" width="5" height="5" fill="black" />
                    <rect x="140" y="80" width="5" height="5" fill="black" />
                    <rect x="80" y="120" width="5" height="5" fill="black" />
                    <rect x="90" y="120" width="5" height="5" fill="black" />
                    <rect x="100" y="120" width="5" height="5" fill="black" />
                    <rect x="110" y="120" width="5" height="5" fill="black" />
                    <rect x="120" y="120" width="5" height="5" fill="black" />
                    <rect x="80" y="160" width="5" height="5" fill="black" />
                    <rect x="90" y="160" width="5" height="5" fill="black" />
                    <rect x="100" y="160" width="5" height="5" fill="black" />
                    <rect x="110" y="160" width="5" height="5" fill="black" />
                    <rect x="120" y="160" width="5" height="5" fill="black" />
                    <rect x="130" y="160" width="5" height="5" fill="black" />
                    <rect x="140" y="160" width="5" height="5" fill="black" />
                    <rect x="150" y="160" width="5" height="5" fill="black" />
                    <rect x="160" y="160" width="5" height="5" fill="black" />
                    <rect x="170" y="160" width="5" height="5" fill="black" />
                    <rect x="25" y="95" width="5" height="5" fill="black" />
                    <rect x="35" y="95" width="5" height="5" fill="black" />
                    <rect x="45" y="95" width="5" height="5" fill="black" />
                    <rect x="55" y="95" width="5" height="5" fill="black" />
                    <rect x="65" y="95" width="5" height="5" fill="black" />
                    <rect x="135" y="95" width="5" height="5" fill="black" />
                    <rect x="145" y="95" width="5" height="5" fill="black" />
                    <rect x="155" y="95" width="5" height="5" fill="black" />
                    <rect x="165" y="95" width="5" height="5" fill="black" />
                    <rect x="175" y="95" width="5" height="5" fill="black" />
                  </svg>
                </div>
              </div>
              <div class="qr-instructions">
                <p class="instruction-text">è¯·ä½¿ç”¨ä¸­å›½é“è·¯12306æ‰‹æœºå®¢æˆ·ç«¯æ‰«æä¸Šæ–¹äºŒç»´ç </p>
                <p class="instruction-note">æ‰«ç åæŒ‰ç…§APPæç¤ºå®Œæˆèº«ä»½éªŒè¯å³å¯æ‰¾å›å¯†ç </p>
              </div>
              <div class="form-actions">
                <a-button type="primary" size="large" class="submit-btn" :loading="loading" @click="proceedFaceStep2">å·²æ‰«ç ï¼Œç»§ç»­</a-button>
              </div>
            </div>

            <div class="form-content" v-if="faceStep === 2">
              <a-form :model="verificationForm" layout="vertical" class="recovery-form">
                <a-form-item label="éªŒè¯ç ï¼š" required>
                  <a-input v-model:value="verificationForm.code" placeholder="è¯·è¾“å…¥æ”¶åˆ°çš„éªŒè¯ç " size="large" />
                </a-form-item>
                <div class="form-actions">
                  <a-button type="primary" size="large" class="submit-btn" :loading="loading" @click="handleVerifyCode('face')">éªŒè¯</a-button>
                </div>
              </a-form>
            </div>

            <div class="form-content" v-if="faceStep === 3">
              <a-form :model="passwordForm" layout="vertical" class="recovery-form">
                <a-form-item label="æ–°å¯†ç ï¼š" required>
                  <a-input v-model:value="passwordForm.newPassword" type="password" placeholder="è¯·è¾“å…¥æ–°å¯†ç " size="large" />
                </a-form-item>
                <a-form-item label="ç¡®è®¤æ–°å¯†ç ï¼š" required>
                  <a-input v-model:value="passwordForm.confirmPassword" type="password" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " size="large" />
                </a-form-item>
                <div class="form-actions">
                  <a-button type="primary" size="large" class="submit-btn" :loading="loading" @click="handleSetNewPassword('face')">æäº¤</a-button>
                </div>
              </a-form>
            </div>

            <div class="qr-content" v-if="faceStep === 4">
              <h3 class="recovery-title">å¯†ç é‡ç½®æˆåŠŸ</h3>
              <p class="recovery-subtitle">å³å°†è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•</p>
            </div>
          </div>

          <!-- æ‰‹æœºæ‰¾å› -->
          <div v-if="activeTab === 'phone'" class="phone-recovery">
            <div class="step-indicator">
              <div class="step" :class="{ active: phoneStep >= 1, completed: phoneStep > 1 }">
                <div class="step-number">1</div>
                <div class="step-text">å¡«å†™è´¦æˆ·ä¿¡æ¯</div>
              </div>
              <div class="step-line"></div>
              <div class="step" :class="{ active: phoneStep >= 2, completed: phoneStep > 2 }">
                <div class="step-number">2</div>
                <div class="step-text">è·å–éªŒè¯ç </div>
              </div>
              <div class="step-line"></div>
              <div class="step" :class="{ active: phoneStep >= 3, completed: phoneStep > 3 }">
                <div class="step-number">3</div>
                <div class="step-text">è®¾ç½®æ–°å¯†ç </div>
              </div>
              <div class="step-line"></div>
              <div class="step" :class="{ active: phoneStep >= 4 }">
                <div class="step-number">4</div>
                <div class="step-text">å®Œæˆ</div>
              </div>
            </div>

            <div class="form-content">
              <a-form :model="phoneForm" layout="vertical" class="recovery-form">
                <a-form-item label="æ‰‹æœºå·ç ï¼š" required>
                  <a-input
                    v-model:value="phoneForm.phone"
                    placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·ç "
                    size="large"
                    addon-before="+86"
                  />
                  <div class="form-hint">å·²é€šè¿‡æ ¸éªŒçš„æ‰‹æœºå·ç </div>
                </a-form-item>

                <a-form-item label="è¯ä»¶ç±»å‹ï¼š" required>
                  <a-select
                    v-model:value="phoneForm.idType"
                    placeholder="è¯·é€‰æ‹©è¯ä»¶ç±»å‹"
                    size="large"
                  >
                    <a-select-option value="èº«ä»½è¯">å±…æ°‘èº«ä»½è¯</a-select-option>
                    <a-select-option value="æŠ¤ç…§">æŠ¤ç…§</a-select-option>
                    <a-select-option value="æ¸¯æ¾³é€šè¡Œè¯">æ¸¯æ¾³å±…æ°‘æ¥å¾€å†…åœ°é€šè¡Œè¯</a-select-option>
                    <a-select-option value="å°èƒè¯">å°æ¹¾å±…æ°‘æ¥å¾€å¤§é™†é€šè¡Œè¯</a-select-option>
                  </a-select>
                  <div class="form-hint">è¯·é€‰æ‹©è¯ä»¶ç±»å‹</div>
                </a-form-item>

                <a-form-item label="è¯ä»¶å·ç ï¼š" required>
                  <a-input
                    v-model:value="phoneForm.idNumber"
                    placeholder="è¯·è¾“å…¥è¯ä»¶å·ç "
                    size="large"
                  />
                  <div class="form-hint">è¯·è¾“å…¥è¯ä»¶å·ç </div>
                </a-form-item>

                <div class="form-actions">
                  <a-button
                    type="primary"
                    size="large"
                    class="submit-btn"
                    :loading="loading"
                    @click="handlePhoneSubmit"
                  >
                    æäº¤
                  </a-button>
                </div>
              </a-form>

              <div class="help-text">
                æ‰‹æœºå·æœªé€šè¿‡æ ¸éªŒï¼Ÿ
                <a href="#" class="help-link" @click.prevent="activeTab = 'email'">è¯•è¯•é‚®ç®±æ‰¾å›</a>
              </div>
            </div>

            <div class="form-content" v-if="phoneStep === 2">
              <a-form :model="verificationForm" layout="vertical" class="recovery-form">
                <a-form-item label="éªŒè¯ç ï¼š" required>
                  <a-input v-model:value="verificationForm.code" placeholder="è¯·è¾“å…¥çŸ­ä¿¡éªŒè¯ç " size="large" />
                </a-form-item>
                <div class="form-actions">
                  <a-button type="primary" size="large" class="submit-btn" :loading="loading" @click="handleVerifyCode('phone')">éªŒè¯</a-button>
                </div>
              </a-form>
            </div>

            <div class="form-content" v-if="phoneStep === 3">
              <a-form :model="passwordForm" layout="vertical" class="recovery-form">
                <a-form-item label="æ–°å¯†ç ï¼š" required>
                  <a-input v-model:value="passwordForm.newPassword" type="password" placeholder="è¯·è¾“å…¥æ–°å¯†ç " size="large" />
                </a-form-item>
                <a-form-item label="ç¡®è®¤æ–°å¯†ç ï¼š" required>
                  <a-input v-model:value="passwordForm.confirmPassword" type="password" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " size="large" />
                </a-form-item>
                <div class="form-actions">
                  <a-button type="primary" size="large" class="submit-btn" :loading="loading" @click="handleSetNewPassword('phone')">æäº¤</a-button>
                </div>
              </a-form>
            </div>

            <div class="qr-content" v-if="phoneStep === 4">
              <h3 class="recovery-title">å¯†ç é‡ç½®æˆåŠŸ</h3>
              <p class="recovery-subtitle">å³å°†è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•</p>
            </div>
          </div>

          <!-- é‚®ç®±æ‰¾å› -->
          <div v-if="activeTab === 'email'" class="email-recovery">
            <div class="step-indicator">
              <div class="step" :class="{ active: emailStep >= 1, completed: emailStep > 1 }">
                <div class="step-number">1</div>
                <div class="step-text">å¡«å†™è´¦æˆ·ä¿¡æ¯</div>
              </div>
              <div class="step-line"></div>
              <div class="step" :class="{ active: emailStep >= 2, completed: emailStep > 2 }">
                <div class="step-number">2</div>
                <div class="step-text">éªŒè¯éªŒè¯ç </div>
              </div>
              <div class="step-line"></div>
              <div class="step" :class="{ active: emailStep >= 3, completed: emailStep > 3 }">
                <div class="step-number">3</div>
                <div class="step-text">è®¾ç½®æ–°å¯†ç </div>
              </div>
              <div class="step-line"></div>
              <div class="step" :class="{ active: emailStep >= 4 }">
                <div class="step-number">4</div>
                <div class="step-text">å®Œæˆ</div>
              </div>
            </div>

            <div class="email-form-content" v-if="emailStep === 1">
              <a-form :model="emailForm" layout="vertical" class="email-recovery-form">
                <a-form-item required>
                  <template #label>
                    <span class="form-label">
                      <span class="required-star">*</span>
                      ç”µå­é‚®ä»¶ï¼š
                    </span>
                  </template>
                  <a-input v-model:value="emailForm.email" placeholder="æ³¨å†Œæ—¶æ‰€å¡«çš„ç”µå­é‚®ç®±" size="large" class="form-input" />
                </a-form-item>
                <a-form-item required>
                  <template #label>
                    <span class="form-label">
                      <span class="required-star">*</span>
                      è¯ä»¶ç±»å‹ï¼š
                    </span>
                  </template>
                  <a-select v-model:value="emailForm.idType" placeholder="è¯·é€‰æ‹©è¯ä»¶ç±»å‹" size="large" class="form-input">
                    <a-select-option value="èº«ä»½è¯">å±…æ°‘èº«ä»½è¯</a-select-option>
                    <a-select-option value="æŠ¤ç…§">æŠ¤ç…§</a-select-option>
                    <a-select-option value="æ¸¯æ¾³é€šè¡Œè¯">æ¸¯æ¾³å±…æ°‘æ¥å¾€å†…åœ°é€šè¡Œè¯</a-select-option>
                    <a-select-option value="å°èƒè¯">å°æ¹¾å±…æ°‘æ¥å¾€å¤§é™†é€šè¡Œè¯</a-select-option>
                  </a-select>
                </a-form-item>
                <a-form-item required>
                  <template #label>
                    <span class="form-label">
                      <span class="required-star">*</span>
                      è¯ä»¶å·ç ï¼š
                    </span>
                  </template>
                  <a-input v-model:value="emailForm.idNumber" placeholder="è¯·è¾“å…¥è¯ä»¶å·ç " size="large" class="form-input" />
                </a-form-item>
                <div class="form-actions">
                  <a-button type="primary" size="large" class="submit-btn" :loading="loading" @click="handleEmailSubmit">æäº¤</a-button>
                </div>
              </a-form>
            </div>

            <div class="form-content" v-if="emailStep === 2">
              <a-form :model="verificationForm" layout="vertical" class="email-recovery-form">
                <a-form-item required>
                  <template #label>
                    <span class="form-label">
                      <span class="required-star">*</span>
                      éªŒè¯ç ï¼š
                    </span>
                  </template>
                  <a-input v-model:value="verificationForm.code" placeholder="è¯·è¾“å…¥é‚®ç®±éªŒè¯ç " size="large" class="form-input" />
                </a-form-item>
                <div class="form-actions">
                  <a-button type="primary" size="large" class="submit-btn" :loading="loading" @click="handleVerifyCode('email')">éªŒè¯</a-button>
                </div>
              </a-form>
            </div>

            <div class="form-content" v-if="emailStep === 3">
              <a-form :model="passwordForm" layout="vertical" class="email-recovery-form">
                <a-form-item required>
                  <template #label>
                    <span class="form-label">
                      <span class="required-star">*</span>
                      æ–°å¯†ç ï¼š
                    </span>
                  </template>
                  <a-input v-model:value="passwordForm.newPassword" type="password" placeholder="è¯·è¾“å…¥æ–°å¯†ç " size="large" class="form-input" />
                </a-form-item>
                <a-form-item required>
                  <template #label>
                    <span class="form-label">
                      <span class="required-star">*</span>
                      ç¡®è®¤æ–°å¯†ç ï¼š
                    </span>
                  </template>
                  <a-input v-model:value="passwordForm.confirmPassword" type="password" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " size="large" class="form-input" />
                </a-form-item>
                <div class="form-actions">
                  <a-button type="primary" size="large" class="submit-btn" :loading="loading" @click="handleSetNewPassword('email')">æäº¤</a-button>
                </div>
              </a-form>
            </div>

            <div class="qr-content" v-if="emailStep === 4">
              <h3 class="recovery-title">å¯†ç é‡ç½®æˆåŠŸ</h3>
              <p class="recovery-subtitle">å³å°†è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, watch } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { message } from 'ant-design-vue'
import {
  submitFaceRecovery,
  submitPhoneRecovery,
  submitEmailRecovery,
  verifyRecoveryCode,
  setNewPassword
} from '@/api/auth'

const router = useRouter()
const route = useRoute()

// å½“å‰æ¿€æ´»çš„é€‰é¡¹å¡
const activeTab = ref('face')

// æ­¥éª¤çŠ¶æ€
const faceStep = ref(1)
const phoneStep = ref(1)
const emailStep = ref(1)

// åŠ è½½çŠ¶æ€
const loading = ref(false)

// æ¢å¤ä»¤ç‰Œ
const recoveryToken = ref('')

// è¡¨å•æ•°æ®
const faceForm = reactive({
  email: '',
  idType: '',
  idNumber: ''
})

const phoneForm = reactive({
  phone: '',
  idType: '',
  idNumber: ''
})

const emailForm = reactive({
  email: '',
  idType: '',
  idNumber: ''
})

// éªŒè¯ç è¡¨å•
const verificationForm = reactive({
  code: ''
})

// æ–°å¯†ç è¡¨å•
const passwordForm = reactive({
  newPassword: '',
  confirmPassword: ''
})

// è¡¨å•éªŒè¯
const validateForm = (form, type) => {
  if (type === 'face' || type === 'email') {
    if (!form.email) {
      message.error('è¯·è¾“å…¥é‚®ç®±åœ°å€')
      return false
    }
  }
  if (type === 'phone') {
    if (!form.phone) {
      message.error('è¯·è¾“å…¥æ‰‹æœºå·ç ')
      return false
    }
  }
  if (!form.idType) {
    message.error('è¯·é€‰æ‹©è¯ä»¶ç±»å‹')
    return false
  }
  if (!form.idNumber) {
    message.error('è¯·è¾“å…¥è¯ä»¶å·ç ')
    return false
  }
  return true
}

// å¤„ç†äººè„¸æ‰¾å›æäº¤
const handleFaceSubmit = async () => {
  if (!validateForm(faceForm, 'face')) return

  try {
    loading.value = true
    const response = await submitFaceRecovery(faceForm)

    if (response.code === 200) {
      recoveryToken.value = response.data.token
      message.success('éªŒè¯ä¿¡æ¯å·²æäº¤ï¼Œè¯·æŒ‰ç…§æç¤ºå®Œæˆåç»­æ­¥éª¤')
      faceStep.value = 2
    } else {
      message.error(response.message || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  } catch (error) {
    console.error('äººè„¸æ‰¾å›æäº¤å¤±è´¥:', error)
    message.error('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•')
  } finally {
    loading.value = false
  }
}

// å¤„ç†æ‰‹æœºæ‰¾å›æäº¤
const handlePhoneSubmit = async () => {
  if (!validateForm(phoneForm, 'phone')) return

  try {
    loading.value = true
    const response = await submitPhoneRecovery(phoneForm)

    if (response.code === 200) {
      recoveryToken.value = response.data.token
      message.success('éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„æ‰‹æœº')
      router.push({ path: '/forgot-password/verify', query: { type: 'phone', token: recoveryToken.value } })
    } else {
      message.error(response.message || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  } catch (error) {
    console.error('æ‰‹æœºæ‰¾å›æäº¤å¤±è´¥:', error)
    message.error('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•')
  } finally {
    loading.value = false
  }
}

// å¤„ç†é‚®ç®±æ‰¾å›æäº¤
const handleEmailSubmit = async () => {
  if (!validateForm(emailForm, 'email')) return

  try {
    loading.value = true
    const response = await submitEmailRecovery(emailForm)

    if (response.code === 200) {
      recoveryToken.value = response.data.token
      message.success('éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±')
      router.push({ path: '/forgot-password/verify', query: { type: 'email', token: recoveryToken.value } })
    } else {
      message.error(response.message || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  } catch (error) {
    console.error('é‚®ç®±æ‰¾å›æäº¤å¤±è´¥:', error)
    message.error('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•')
  } finally {
    loading.value = false
  }
}

const handleVerifyCode = async type => {
  if (!verificationForm.code) {
    message.error('è¯·è¾“å…¥éªŒè¯ç ')
    return
  }
  loading.value = true
  setTimeout(() => {
    message.success('å·²æäº¤éªŒè¯ç ï¼ˆå ä½ç¬¦ï¼‰')
    if (type === 'face') {
      faceStep.value = 3
      router.replace({ path: '/forgot-password', query: { type: 'face', step: 3 } })
    }
    if (type === 'phone') {
      phoneStep.value = 3
      router.replace({ path: '/forgot-password', query: { type: 'phone', step: 3 } })
    }
    if (type === 'email') {
      emailStep.value = 3
      router.replace({ path: '/forgot-password', query: { type: 'email', step: 3 } })
    }
    loading.value = false
  }, 300)
}

// è®¾ç½®æ–°å¯†ç 
const handleSetNewPassword = async type => {
  if (!passwordForm.newPassword) {
    message.error('è¯·è¾“å…¥æ–°å¯†ç ')
    return
  }
  if (!passwordForm.confirmPassword) {
    message.error('è¯·ç¡®è®¤æ–°å¯†ç ')
    return
  }
  if (passwordForm.newPassword !== passwordForm.confirmPassword) {
    message.error('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´')
    return
  }

  try {
    loading.value = true
    const response = await setNewPassword({
      token: recoveryToken.value,
      newPassword: passwordForm.newPassword,
      confirmPassword: passwordForm.confirmPassword
    })

    if (response.code === 200) {
      message.success('å¯†ç é‡ç½®æˆåŠŸï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•')
      router.replace({ path: '/forgot-password/done', query: { type } })
    } else {
      message.error(response.message || 'å¯†ç é‡ç½®å¤±è´¥')
    }
  } catch (error) {
    console.error('å¯†ç é‡ç½®å¤±è´¥:', error)
    message.error('å¯†ç é‡ç½®å¤±è´¥ï¼Œè¯·é‡è¯•')
  } finally {
    loading.value = false
  }
}
const initFromRoute = () => {
  const t = route.query.type
  const s = Number(route.query.step || 1)
  if (t === 'phone' || t === 'email' || t === 'face') activeTab.value = t
  if (activeTab.value === 'phone') phoneStep.value = s
  if (activeTab.value === 'email') emailStep.value = s
  if (activeTab.value === 'face') faceStep.value = s
}
initFromRoute()
watch(() => route.query, () => initFromRoute(), { deep: true })

const proceedFaceStep2 = () => {
  router.push({ path: '/forgot-password/verify', query: { type: 'face' } })
}
</script>

<style scoped>
.forgot-password-page {
  min-height: 100vh;
  background: linear-gradient(135deg, #4a90e2 0%, #357abd 50%, #1e5f99 100%);
  position: relative;
  overflow: hidden;
}

.forgot-password-page::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 600"><path d="M0,300 Q300,200 600,300 T1200,300 L1200,600 L0,600 Z" fill="rgba(255,255,255,0.1)"/></svg>')
    no-repeat center;
  background-size: cover;
}

.header {
  background: #fff;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  height: 60px;
  display: flex;
  align-items: center;
  position: relative;
  z-index: 2;
}

.header-content {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logo {
  display: flex;
  align-items: center;
  gap: 8px;
}

.logo-icon {
  width: 32px;
  height: 32px;
  background: #e60012;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 16px;
}

.logo-text {
  font-size: 18px;
  font-weight: bold;
  color: #333;
}

.subtitle {
  font-size: 12px;
  color: #666;
  margin-left: 5px;
}

.header-nav {
  display: flex;
  gap: 10px;
}

.main-content {
  padding: 50px 20px;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: calc(100vh - 60px);
  position: relative;
  z-index: 1;
}

.forgot-container {
  background: white;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  width: 100%;
  max-width: 800px;
  overflow: hidden;
}

.tab-navigation {
  display: flex;
  border-bottom: 1px solid #e8e8e8;
}

.tab-item {
  flex: 1;
  padding: 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: #666;
  border-bottom: 2px solid transparent;
}

.tab-item:hover {
  background: #f5f5f5;
}

.tab-item.active {
  color: #ff6600;
  border-bottom-color: #ff6600;
  background: white;
}

.tab-item i {
  font-size: 24px;
}

.icon-face::before {
  content: 'ğŸ‘¤';
}

.icon-phone::before {
  content: 'ğŸ“±';
}

.icon-email::before {
  content: 'ğŸ“§';
}

.tab-content {
  padding: 40px;
}

.step-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 40px;
}

.step {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.step-number {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #f0f0f0;
  color: #999;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  transition: all 0.3s;
}

.step.active .step-number {
  background: #ff6600;
  color: #fff;
}

.step.completed .step-number {
  background: #52c41a;
  color: #fff;
}

.step-text {
  font-size: 12px;
  color: #666;
  white-space: nowrap;
}

.step.active .step-text {
  color: #ff6600;
}

.step-line {
  width: 60px;
  height: 2px;
  background: #f0f0f0;
  margin: 0 10px;
}

.form-content {
  max-width: 400px;
  margin: 0 auto;
}

.recovery-form {
  margin-bottom: 20px;
}

.form-hint {
  font-size: 12px;
  color: #999;
  margin-top: 4px;
}

.form-actions {
  margin-top: 30px;
}

.submit-btn {
  width: 100%;
  height: 44px;
  font-size: 16px;
  border-radius: 6px;
  background: #ff6600;
  border: none;
  color: white;
  font-weight: 500;
  transition: all 0.3s;
}

.submit-btn:hover {
  background: #e55a00;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(255, 102, 0, 0.3);
}

.submit-btn:active {
  transform: translateY(0);
}

.submit-btn:disabled {
  background: #d9d9d9;
  color: rgba(0, 0, 0, 0.25);
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.help-text {
  text-align: center;
  font-size: 14px;
  color: #666;
}

.help-link {
  color: #ff6600;
  text-decoration: none;
  transition: color 0.3s;
}

.help-link:hover {
  color: #e55a00;
  text-decoration: underline;
}

/* äººè„¸æ‰¾å›äºŒç»´ç æ ·å¼ */
.qr-content {
  text-align: center;
  padding: 30px 20px;
}

.recovery-title {
  font-size: 20px;
  font-weight: bold;
  color: #333;
  margin-bottom: 12px;
}

.recovery-subtitle {
  font-size: 14px;
  color: #666;
  margin-bottom: 30px;
  line-height: 1.4;
}

.app-name {
  color: #ff6600;
  font-weight: bold;
}

.qr-code-container {
  display: flex;
  justify-content: center;
  margin-bottom: 24px;
}

.qr-code {
  padding: 15px;
  background: white;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  border: 1px solid #e8e8e8;
}

.qr-instructions {
  max-width: 350px;
  margin: 0 auto;
}

.instruction-text {
  font-size: 13px;
  color: #333;
  margin-bottom: 6px;
  line-height: 1.4;
}

.instruction-note {
  font-size: 11px;
  color: #999;
  line-height: 1.3;
}

/* é‚®ç®±æ‰¾å›æ ·å¼ */
.email-recovery {
  padding: 0;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  min-height: 400px;
  padding-top: 60px;
}

.email-form-content {
  padding: 20px 25px;
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}

.email-recovery-form {
  max-width: 380px;
  margin: 0 auto;
  width: 100%;
}

.email-recovery-form .ant-form-item {
  margin-bottom: 18px;
}

.email-recovery-form .form-label {
  font-size: 13px;
  color: #333;
  font-weight: normal;
  display: flex;
  align-items: center;
}

.email-recovery-form .required-star {
  color: #ff4d4f;
  margin-right: 3px;
  font-size: 13px;
}

.email-recovery-form .form-input {
  border-radius: 4px;
  border: 1px solid #d9d9d9;
}

.email-recovery-form .form-input:hover {
  border-color: #40a9ff;
}

.email-recovery-form .form-input:focus,
.email-recovery-form .form-input.ant-input-focused {
  border-color: #40a9ff;
  box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
}

.email-recovery-form .ant-select .ant-select-selector {
  border-radius: 4px;
  border: 1px solid #d9d9d9;
}

.email-recovery-form .ant-select:hover .ant-select-selector {
  border-color: #40a9ff;
}

.email-recovery-form .ant-select.ant-select-focused .ant-select-selector {
  border-color: #40a9ff;
  box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
}

.email-recovery-form .form-actions {
  text-align: center;
  margin-top: 24px;
}

.email-recovery-form .submit-btn {
  background: #ff6600;
  border-color: #ff6600;
  border-radius: 4px;
  font-size: 14px;
  font-weight: 500;
  height: 36px;
  min-width: 100px;
  transition: all 0.3s ease;
}

.email-recovery-form .submit-btn:hover {
  background: #e55a00;
  border-color: #e55a00;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(255, 102, 0, 0.3);
}

.email-recovery-form .submit-btn:active {
  transform: translateY(0);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .header-content {
    padding: 0 10px;
  }

  .logo-text {
    font-size: 16px;
  }

  .subtitle {
    display: none;
  }

  .main-content {
    padding: 20px 10px;
  }

  .tab-content {
    padding: 20px;
  }

  .step-indicator {
    flex-wrap: wrap;
    gap: 10px;
  }

  .step-line {
    width: 30px;
  }

  .tab-item {
    padding: 15px 10px;
    font-size: 12px;
  }

  /* äºŒç»´ç ç§»åŠ¨ç«¯é€‚é… */
  .qr-content {
    padding: 15px 10px;
  }

  .recovery-title {
    font-size: 18px;
  }

  .recovery-subtitle {
    font-size: 13px;
    margin-bottom: 20px;
  }

  .qr-code svg {
    width: 140px;
    height: 140px;
  }

  .qr-code {
    padding: 12px;
  }

  /* é‚®ç®±æ‰¾å›ç§»åŠ¨ç«¯é€‚é… */
  .email-recovery {
    padding-top: 40px;
    min-height: 350px;
  }

  .email-form-content {
    padding: 15px 12px;
  }

  .email-recovery-form .ant-form-item {
    margin-bottom: 16px;
  }

  .email-recovery-form .form-actions {
    margin-top: 20px;
  }

  .email-recovery-form .submit-btn {
    width: 100%;
    height: 40px;
  }
}
</style>
